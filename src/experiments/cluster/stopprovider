#!/usr/bin/python3.8
import os
import subprocess

def is_root():
    """Check if the script is run as root."""
    return os.geteuid() == 0

def module_loaded(module_name):
    """Check if a given module is loaded."""
    result = subprocess.run(['lsmod'], capture_output=True, text=True)
    return module_name in result.stdout

def unload_module(module_name):
    """Unload a kernel module."""
    if module_loaded(module_name):
        subprocess.run(['modprobe', '-r', module_name], check=True)
        print(f"Module {module_name} unloaded.")
    else:
        print(f"Module {module_name} is not loaded.")

def unmount_ramdisk(ramdisk_path):
    """Unmount the ramdisk."""
    result = subprocess.run(['mount'], capture_output=True, text=True)
    if ramdisk_path in result.stdout:
        subprocess.run(['umount', ramdisk_path], check=True)
        print(f"Ramdisk at {ramdisk_path} unmounted.")
    else:
        print(f"No ramdisk found at {ramdisk_path}.")

def cleanup_exports_and_permissions(ramdisk_path, ip_address):
    """Placeholder function for cleaning up /etc/exports and /etc/hosts.allow."""
    # Implement cleaning of NFS exports and permissions as needed.
    print("Cleaning up NFS exports and permissions is not automated in this script. Please do it manually if necessary.")

def main(ramdisk_path='/mnt/ramdisk', ip_address=''):
    if not is_root():
        print("This script must be run as root.")
        exit(1)

    unmount_ramdisk(ramdisk_path)
    
    # Unload RDMA modules if necessary. Be cautious with unloading kernel modules as it might affect other services.
    # unload_module('rpcrdma')

    cleanup_exports_and_permissions(ramdisk_path, ip_address)

if __name__ == "__main__":
    import sys
    if len(sys.argv) < 2:
        print("Usage: python cleanup_script.py <ramdisk path> <IP address>")
        exit(1)
    main(sys.argv[1], sys.argv[2] if len(sys.argv) > 2 else '')
